<html>
<head>
<script type="text/javascript">

var gameEngine = {
    init : function(canvasId) {
        gameEngine.canvas = document.getElementById(canvasId);
        gameEngine.canvas.addEventListener('mousemove', function(e) {
            if (gameEngine.mouse === undefined) {
                gameEngine.mouse = {};
            }
            var canvasRect = gameEngine.canvas.getBoundingClientRect();
            gameEngine.mouse.x = e.pageX - canvasRect.left; 
            gameEngine.mouse.y = e.pageY - canvasRect.top;
        });
        gameEngine.context = gameEngine.canvas.getContext("2d");
        gameEngine.width = gameEngine.canvas.width;
        gameEngine.height = gameEngine.canvas.height;
    },
    running : true,
    objects : [], 
    start : function() {
        gameEngine.time = new Date().getTime();
        setTimeout(gameEngine.tick, 1); //start game loop
        gameEngine.renderIntervalID = setInterval(function(){gameEngine.render();}, 1000/60); //render at 60fps max
    },
    stop : function() {
        gameEngine.running = false;
        clearInterval(gameEngine.renderIntervalID);
    },
    render : function() {
        gameEngine.context.clearRect(0, 0, gameEngine.width, gameEngine.height);
        gameEngine.objects.map(function (object) {
            if (object.paint !== undefined) {
                object.paint(gameEngine.context);
            }
        });
        if (gameEngine.lastRender !== undefined) {
            var fps = Math.floor(1000/(new Date().getTime() - gameEngine.lastRender));
            gameEngine.context.font = '10pt Calibri';
            gameEngine.context.fillStyle = 'red';
            gameEngine.context.fillText(fps + " FPS", gameEngine.width-50, gameEngine.height-10);
        };
        gameEngine.lastRender = new Date().getTime();
    }, 
    tick : function() {
        var currentTime = new Date().getTime();
        var timeDelta = currentTime - gameEngine.time;
        gameEngine.time = currentTime;
        if (timeDelta > 0) {
            gameEngine.objects.map(function (object) {
                if (object.update !== undefined) {
                    object.update(timeDelta);
                }
            });
        }
        if (gameEngine.running) {
            setTimeout(function(){gameEngine.tick();}, 1); //game loop
        }
    }
};

</script>
</head>
<body>
<h3> Canvas demo </h3>
<button onclick="gameEngine.stop();">Stop</button>
<canvas id="gameScreen" width="1024" height="768" />
<script type="text/javascript">
    var FORCE = 1000;
    var MAX_VEL = 1;
    var Bot = function(x,y) {

        if (Bot.prototype.img == undefined) {
            Bot.prototype.img = new Image();
            Bot.prototype.img.src = "bluering.png";
        }
        this.x = x;
        this.y = y;
        this.vx = 0;
        this.vy = 0;
    };

    Bot.prototype.paint = function(context) {
        context.drawImage(this.img, this.x,this.y);
    };

    Bot.prototype.update = function(timeDelta) {
        var vx = 0;
        var vy = 0;
        var thiz = this;
        //apply neighbor repelling force
        gameEngine.objects.map(function(otherBot) {
            if (otherBot === thiz) {
                return;
            }
            var dx = thiz.x - otherBot.x;
            var dy = thiz.y - otherBot.y;
            var magnitude = Math.sqrt(dx*dx + dy*dy)/2;
            if (dx + dy != 0) {
                vx += FORCE/(Math.pow(magnitude,3))*(dx/(Math.abs(dx)+Math.abs(dy)));
                vy += FORCE/(Math.pow(magnitude,3))*(dy/(Math.abs(dx)+Math.abs(dy)));
            }
        });
        //apply wall repelling force
        var walls = [{x:this.x,y:0}, {x:this.x, y:gameEngine.height}, {x:0, y:this.y}, {x:gameEngine.width, y:this.y}];
        if (gameEngine.mouse !== undefined) {
            walls.push({x:gameEngine.mouse.x, y:gameEngine.mouse.y});
        }
        walls.map(function(wall) {
            var dx = thiz.x - wall.x;
            var dy = thiz.y - wall.y;
            if (dx + dy != 0) {
                var magnitude = Math.sqrt(dx*dx + dy*dy);
                vx += FORCE/(Math.pow(magnitude,3))*(dx/(Math.abs(dx)+Math.abs(dy)));
                vy += FORCE/(Math.pow(magnitude,3))*(dy/(Math.abs(dx)+Math.abs(dy)));
            }
        });

        this.vx = vx*timeDelta;
        this.vy = vy*timeDelta;
        if (Math.abs(this.vx) > MAX_VEL) {
            if (this.vx > 0) {
                this.vx = MAX_VEL;
            } else {
                this.vx = -1 * MAX_VEL;
            }
        }
        if (Math.abs(this.vy) > MAX_VEL) {
            if (this.vy > 0) {
                this.vy = MAX_VEL;
            } else {
                this.vy = -1 * MAX_VEL;
            }
        }
            

        if (this.x > gameEngine.width || this.x < 0) {
            this.vx *= -1;
        }
        if (this.y > gameEngine.height || this.y < 0) {
            this.vy *= -1;
        }
            this.x = this.x + (this.vx * timeDelta); 
            this.y = this.y + (this.vy * timeDelta); 
    };
    
    gameEngine.init("gameScreen");
    for(var i=0; i<75; i++) {
        var bot = new Bot(Math.random()*gameEngine.width,Math.random()*gameEngine.height);
        gameEngine.objects.push(bot);
    }
    gameEngine.start();
    //start render
</script>
</body>
</html>
